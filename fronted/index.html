<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>× ×™×”×•×œ ×¦×™ ×¨×›×‘×™×</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;600;700&family=Rubik:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <style>
    :root {
      --bg: #f3efe7;
      --card: #ffffff;
      --ink: #1f1f24;
      --muted: #6e6f77;
      --accent: #ff7a59;
      --accent-dark: #d85a3a;
      --shadow: 0 18px 40px rgba(20, 20, 20, 0.12);
      --shadow-soft: 0 12px 24px rgba(20, 20, 20, 0.08);
    }

    body {
      font-family: "Rubik", "Heebo", "Tahoma", sans-serif;
      background:
        radial-gradient(circle at 10% 10%, rgba(255, 122, 89, 0.12), transparent 55%),
        radial-gradient(circle at 90% 20%, rgba(58, 91, 167, 0.12), transparent 50%),
        radial-gradient(circle at 20% 85%, rgba(42, 127, 98, 0.12), transparent 45%),
        var(--bg);
      color: var(--ink);
      min-height: 100vh;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    .hero {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }

    .hero h1 {
      font-weight: 700;
      font-size: clamp(1.7rem, 2.2vw, 2.6rem);
      margin-bottom: 8px;
    }

    .hero p {
      color: var(--muted);
      margin: 0;
      max-width: 520px;
    }

    .hero-badge {
      background: linear-gradient(135deg, var(--accent), #ffb58a);
      color: #fff;
      padding: 16px 20px;
      border-radius: 16px;
      box-shadow: var(--shadow-soft);
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .panel {
      background: var(--card);
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(0, 0, 0, 0.05);
      animation: fadeIn 0.5s ease both;
    }

    .panel + .panel {
      margin-top: 18px;
    }

    .layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .form-panel h6 {
      font-weight: 700;
      margin-bottom: 16px;
    }

    .form-panel .form-control,
    .form-panel .form-select {
      border-radius: 12px;
      padding: 10px 12px;
    }

    .primary-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(255, 122, 89, 0.3);
    }

    .category-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .category-card {
      border-radius: 16px;
      padding: 14px 16px;
      color: #fff;
      position: relative;
      overflow: hidden;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .category-card svg {
      width: 70px;
      height: 40px;
      opacity: 0.9;
    }

    .category-card .count {
      font-size: 1.6rem;
      font-weight: 700;
    }

    .category-card button {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.4);
      color: #fff;
      font-size: 0.85rem;
      padding: 6px 12px;
      border-radius: 999px;
    }

    .category-card button.active {
      background: #fff;
      color: #111;
      font-weight: 600;
    }

    .category-hummer { background: linear-gradient(135deg, #2f6d5b, #4aa987); }
    .category-wrangler { background: linear-gradient(135deg, #7a4b21, #c77a3a); }
    .category-truck { background: linear-gradient(135deg, #4c4e57, #7d7f8a); }
    .category-tiger { background: linear-gradient(135deg, #b14d2e, #f08a4b); }
    .category-wolf { background: linear-gradient(135deg, #2a4a6f, #4f7fb7); }
    .category-eitan { background: linear-gradient(135deg, #46583b, #7aa05d); }
    .category-jltv { background: linear-gradient(135deg, #1d6b8d, #4aa9c2); }
    .category-dmax { background: linear-gradient(135deg, #6e2b7f, #b05ac4); }
    .category-david { background: linear-gradient(135deg, #844b4b, #c27a7a); }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .search-box {
      flex: 1 1 260px;
    }

    .filter-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 6px 14px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      background: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .chip.active {
      background: var(--ink);
      color: #fff;
    }

    .stats {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .car-section {
      margin-top: 20px;
    }

    .car-group-title {
      font-weight: 700;
      margin: 22px 0 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .car-card {
      border-radius: 16px;
      padding: 14px 16px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: var(--shadow-soft);
      margin-bottom: 10px;
      background: #fff;
    }

    .car-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .badge-status {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-active { background: rgba(42, 127, 98, 0.12); color: #1e6b52; }
    .status-inrepair { background: rgba(255, 122, 89, 0.18); color: #b64a30; }
    .status-outofservice { background: rgba(60, 60, 70, 0.15); color: #3a3a43; }

    .badge-category {
      background: rgba(0, 0, 0, 0.08);
      color: #2c2c33;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    .badge-maintenance {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .maintenance-ok { background: rgba(42, 127, 98, 0.12); color: #1e6b52; }
    .maintenance-soon { background: rgba(255, 159, 64, 0.2); color: #a25a12; }
    .maintenance-due { background: rgba(231, 76, 60, 0.18); color: #a43a2f; }
    .maintenance-unknown { background: rgba(120, 120, 130, 0.15); color: #4a4a54; }

    .car-card.maintenance-ok { border-right: 6px solid rgba(42, 127, 98, 0.55); }
    .car-card.maintenance-soon { border-right: 6px solid rgba(255, 159, 64, 0.6); }
    .car-card.maintenance-due { border-right: 6px solid rgba(231, 76, 60, 0.6); }

    .action-buttons {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .action-buttons .btn {
      border-radius: 10px;
    }

    .muted {
      color: var(--muted);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 15, 20, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 2000;
    }

    .modal-card {
      background: #fff;
      border-radius: 18px;
      width: min(420px, 100%);
      box-shadow: var(--shadow);
      padding: 18px;
      animation: fadeIn 0.3s ease both;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .modal-close {
      background: transparent;
      border: none;
      font-size: 1.3rem;
      line-height: 1;
      cursor: pointer;
      color: var(--muted);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }

    .hidden {
      display: none !important;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 600px) {
      .hero {
        flex-direction: column;
        align-items: flex-start;
      }

      .hero-badge {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>

<body>
<div class="page">
  <header class="hero">
    <div>
      <div class="text-uppercase fw-semibold text-muted">CAR444</div>
      <h1>× ×™×”×•×œ ×¦×™ ×¨×›×‘×™ ×”×™×—×™×“×”</h1>
      <p>×™×—×™×“×ª ×”× ×™×•×“ 444</p>
    </div>
    <div class="hero-badge">×‘×§×¨×” ×—×›××” ×œ×¨×›×‘×™ ×”×™×—×™×“×” - CAR444</div>
  </header>

  <section class="layout">
    <div class="panel form-panel">
      <h6>×”×•×¡×¤×ª ×¨×›×‘</h6>
      <input id="plate" class="form-control mb-2" placeholder="××¡×¤×¨ ×¨×™×©×•×™" required>
      <input id="model" class="form-control mb-2" placeholder="×“×’×" required>
      <input id="km" type="number" min="0" inputmode="numeric" class="form-control mb-2" placeholder="×§×´×" required>
      <input id="driver" class="form-control mb-2" placeholder="×©× × ×”×’ (×œ× ×—×•×‘×”)">

      <select id="status" class="form-select mb-2">
        <option value="×¤×¢×™×œ">×¤×¢×™×œ</option>
        <option value="×‘×ª×™×§×•×Ÿ">×‘×ª×™×§×•×Ÿ</option>
        <option value="××•×©×‘×ª">××•×©×‘×ª</option>
      </select>

      <select id="category" class="form-select mb-3"></select>

      <button id="add-btn" type="button" class="primary-btn w-100" onclick="addCar()">â• ×”×•×¡×£ ×¨×›×‘</button>
      <div id="add-error" class="text-danger small mt-2"></div>
    </div>

    <div class="panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0 fw-bold">×§×˜×’×•×¨×™×•×ª ××‘×¦×¢×™×•×ª</h6>
        <span class="muted small">×œ×—×¦×™ ×›×“×™ ×œ×¡× ×Ÿ</span>
      </div>
      <div id="category-grid" class="category-grid"></div>
    </div>
  </section>

  <section class="panel controls">
    <input id="search" class="form-control search-box" placeholder="×—×™×¤×•×© ×œ×¤×™ ×¨×™×©×•×™ / ×“×’× / × ×”×’">
    <div id="filter-chips" class="filter-chips"></div>
    <div class="stats">
      <span id="stat-total">×¡×š ×”×›×œ: 0</span>
      <span id="stat-active">×¤×¢×™×œ: 0</span>
      <span id="stat-repair">×‘×ª×™×§×•×Ÿ: 0</span>
      <span id="stat-out">××•×©×‘×ª: 0</span>
    </div>
  </section>

  <section class="car-section" id="cars"></section>
</div>

<div id="edit-modal" class="modal-overlay hidden" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-header">
      <h5 id="modal-title" class="mb-0">×¢×“×›×•×Ÿ</h5>
      <button class="modal-close" type="button" onclick="closeModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <label id="modal-label" class="form-label"></label>
      <input id="modal-input" class="form-control" />
      <select id="modal-select" class="form-select hidden"></select>
      <div id="modal-error" class="text-danger small mt-2"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline-secondary" type="button" onclick="closeModal()">×‘×™×˜×•×œ</button>
      <button class="btn btn-primary" type="button" onclick="submitModal()">×©××™×¨×”</button>
    </div>
  </div>
</div>

<div id="maintenance-modal" class="modal-overlay hidden" role="dialog" aria-modal="true">
  <div class="modal-card">
    <div class="modal-header">
      <h5 class="mb-0">× ×™×”×•×œ ×˜×™×¤×•×œ×™×</h5>
      <button class="modal-close" type="button" onclick="closeMaintenanceModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="mb-2 fw-semibold">×‘×—×¨×™ ×©×™×˜×ª ××¢×§×‘</div>
      <div class="d-flex gap-2 flex-wrap mb-3">
        <button class="chip" type="button" data-maintenance-mode="km">×œ×¤×™ ×§×´×</button>
        <button class="chip" type="button" data-maintenance-mode="time">×œ×¤×™ ×–××Ÿ</button>
        <button class="chip active" type="button" data-maintenance-mode="both">×©×™×œ×•×‘</button>
      </div>

      <div id="maintenance-km-fields">
        <label class="form-label">×§×´× ××—×¨×•×Ÿ ×œ×˜×™×¤×•×œ</label>
        <input id="maintenance-last-km" type="number" min="0" class="form-control mb-2">
        <label class="form-label">××¨×•×•×— ×˜×™×¤×•×œ ×‘×§×´×</label>
        <input id="maintenance-interval-km" type="number" min="0" class="form-control">
      </div>

      <div id="maintenance-time-fields" class="mt-3">
        <label class="form-label">×ª××¨×™×š ×˜×™×¤×•×œ ××—×¨×•×Ÿ</label>
        <input id="maintenance-last-date" type="date" class="form-control mb-2">
        <label class="form-label">××¨×•×•×— ×˜×™×¤×•×œ (×™××™×)</label>
        <input id="maintenance-interval-days" type="number" min="1" class="form-control">
      </div>

      <div id="maintenance-error" class="text-danger small mt-2"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline-secondary" type="button" onclick="closeMaintenanceModal()">×‘×™×˜×•×œ</button>
      <button class="btn btn-primary" type="button" onclick="submitMaintenance()">×©××™×¨×”</button>
    </div>
  </div>
</div>

<script>
const api = "";
const categories = [
  { key: "×”×××¨", label: "×”×××¨", className: "category-hummer", countId: "count-hummer" },
  { key: "×¨× ×’×œ×¨", label: "×¨× ×’×œ×¨", className: "category-wrangler", countId: "count-wrangler" },
  { key: "××©××™×ª", label: "××©××™×ª", className: "category-truck", countId: "count-truck" },
  { key: "×˜×™×’×¨×™×¡", label: "×˜×™×’×¨×™×¡", className: "category-tiger", countId: "count-tiger" },
  { key: "×–××‘", label: "×–××‘", className: "category-wolf", countId: "count-wolf" },
  { key: "××™×ª×Ÿ", label: "××™×ª×Ÿ", className: "category-eitan", countId: "count-eitan" },
  { key: "JLTV", label: "JLTV", className: "category-jltv", countId: "count-jltv" },
  { key: "×“×™××§×¡", label: "×“×™××§×¡", className: "category-dmax", countId: "count-dmax" },
  { key: "×“×•×“", label: "×“×•×“", className: "category-david", countId: "count-david" }
];
const defaultCategory = categories[0].key;
const statusOptions = ["×¤×¢×™×œ", "×‘×ª×™×§×•×Ÿ", "××•×©×‘×ª"];

let carsCache = [];
let activeFilter = "All";
let modalState = { type: null, plate: null };
let maintenanceState = { plate: null, mode: "both" };

function findCar(plate) {
  return carsCache.find(car => car.license_plate === plate) || null;
}

function resolveCategory(plate) {
  const car = findCar(plate);
  return car?.category || defaultCategory;
}

function normalizeStatus(status) {
  const map = {
    "Active": "×¤×¢×™×œ",
    "In Repair": "×‘×ª×™×§×•×Ÿ",
    "Out of Service": "××•×©×‘×ª"
  };
  return map[status] || status;
}

function daysBetween(dateStr) {
  const msPerDay = 24 * 60 * 60 * 1000;
  const target = new Date(dateStr);
  if (Number.isNaN(target.getTime())) return null;
  const today = new Date();
  const start = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  return Math.floor((start - target) / msPerDay);
}

function evaluateMaintenance(car) {
  const data = {
    lastKm: car.maintenance_last_km,
    intervalKm: car.maintenance_interval_km,
    lastDate: car.maintenance_last_date,
    intervalDays: car.maintenance_interval_days
  };

  if (!data.lastKm && !data.intervalKm && !data.lastDate && !data.intervalDays) {
    return { status: "unknown", label: "×˜×™×¤×•×œ: ×œ× ×”×•×’×“×¨" };
  }

  let kmStatus = null;
  if (data.lastKm !== null && data.intervalKm) {
    const remainingKm = data.intervalKm - (car.km - data.lastKm);
    if (remainingKm <= 0) kmStatus = "due";
    else if (remainingKm <= 500) kmStatus = "soon";
    else kmStatus = "ok";
  }

  let timeStatus = null;
  if (data.lastDate && data.intervalDays) {
    const days = daysBetween(data.lastDate);
    if (days !== null) {
      const remainingDays = data.intervalDays - days;
      if (remainingDays <= 0) timeStatus = "due";
      else if (remainingDays <= 7) timeStatus = "soon";
      else timeStatus = "ok";
    }
  }

  const priority = { due: 3, soon: 2, ok: 1, unknown: 0 };
  const finalStatus = [kmStatus, timeStatus].filter(Boolean).sort((a, b) => priority[b] - priority[a])[0];

  if (!finalStatus) return { status: "unknown", label: "×˜×™×¤×•×œ: ×œ× ×”×•×’×“×¨" };
  if (finalStatus === "due") return { status: "due", label: "×˜×™×¤×•×œ: ×“×—×•×£" };
  if (finalStatus === "soon") return { status: "soon", label: "×˜×™×¤×•×œ: ×‘×§×¨×•×‘" };
  return { status: "ok", label: "×˜×™×¤×•×œ: ×ª×§×™×Ÿ" };
}

function statusClass(status) {
  const normalized = normalizeStatus(status);
  if (normalized === "×¤×¢×™×œ") return "status-active";
  if (normalized === "×‘×ª×™×§×•×Ÿ") return "status-inrepair";
  if (normalized === "××•×©×‘×ª") return "status-outofservice";
  return "status-outofservice";
}

function matchesSearch(car, query) {
  if (!query) return true;
  const text = `${car.license_plate} ${car.model} ${car.driver || ""}`.toLowerCase();
  return text.includes(query);
}

function updateStats(list) {
  const total = list.length;
  const normalized = list.map(car => normalizeStatus(car.status));
  const active = normalized.filter(s => s === "×¤×¢×™×œ").length;
  const repair = normalized.filter(s => s === "×‘×ª×™×§×•×Ÿ").length;
  const out = normalized.filter(s => s === "××•×©×‘×ª").length;

  document.getElementById("stat-total").textContent = `×¡×š ×”×›×œ: ${total}`;
  document.getElementById("stat-active").textContent = `×¤×¢×™×œ: ${active}`;
  document.getElementById("stat-repair").textContent = `×‘×ª×™×§×•×Ÿ: ${repair}`;
  document.getElementById("stat-out").textContent = `××•×©×‘×ª: ${out}`;
}

function updateCategoryCounts(list) {
  const counts = {};
  categories.forEach(category => {
    counts[category.key] = 0;
  });

  list.forEach(car => {
    const category = car.category || defaultCategory;
    counts[category] = (counts[category] || 0) + 1;
  });

  categories.forEach(category => {
    const el = document.getElementById(category.countId);
    if (el) {
      el.textContent = counts[category.key] || 0;
    }
  });
}

function buildCarCard(car) {
  const category = resolveCategory(car.license_plate);
  const statusLabel = normalizeStatus(car.status);
  const statusClassName = statusClass(car.status);
  const maintenance = evaluateMaintenance(car);

  return `
    <div class="car-card maintenance-${maintenance.status}">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <div class="fw-bold">${car.model} <span class="muted">(${car.license_plate})</span></div>
          <div class="car-meta">
            <span>×§×´×: ${car.km}</span>
            <span>× ×”×’: ${car.driver || "â€”"}</span>
          </div>
        </div>
        <div class="d-flex flex-column align-items-end gap-2">
          <span class="badge-status ${statusClassName}">${statusLabel}</span>
          <span class="badge-category">${category}</span>
          <span class="badge-maintenance maintenance-${maintenance.status}">${maintenance.label}</span>
        </div>
      </div>
      <div class="action-buttons">
        <button class="btn btn-sm btn-outline-primary" onclick='openModal("km", "${car.license_plate}", ${car.km})'>âœï¸ ×¢×“×›×•×Ÿ ×§×´×</button>
        <button class="btn btn-sm btn-outline-secondary" onclick='openModal("driver", "${car.license_plate}", "${encodeURIComponent(car.driver || "")}")'>ğŸ‘¤ ×¢×“×›×•×Ÿ × ×”×’</button>
        <button class="btn btn-sm btn-outline-warning" onclick='openModal("status", "${car.license_plate}", "${normalizeStatus(car.status)}")'>âš™ï¸ ×©×™× ×•×™ ×¡×˜×˜×•×¡</button>
        <button class="btn btn-sm btn-outline-success" onclick='openModal("category", "${car.license_plate}", "${category}")'>ğŸ·ï¸ ×§×˜×’×•×¨×™×”</button>
        <button class="btn btn-sm btn-outline-dark" onclick='openMaintenanceModal("${car.license_plate}")'>ğŸ§° ×˜×™×¤×•×œ</button>
        <button class="btn btn-sm btn-outline-danger" onclick='deleteCar("${car.license_plate}")'>âŒ ××—×™×§×”</button>
      </div>
    </div>
  `;
}

function renderCars() {
  const searchValue = document.getElementById("search").value.trim().toLowerCase();
  let list = carsCache.filter(car => matchesSearch(car, searchValue));

  if (activeFilter !== "All") {
    list = list.filter(car => (car.category || defaultCategory) === activeFilter);
  }

  updateStats(list);
  updateCategoryCounts(carsCache);

  const box = document.getElementById("cars");
  box.innerHTML = "";

  if (list.length === 0) {
    box.innerHTML = `<div class="panel text-center muted">××™×Ÿ ×¨×›×‘×™× ×œ×”×¦×’×” ×œ×¤×™ ×”×¡×™× ×•×Ÿ ×”× ×•×›×—×™.</div>`;
    return;
  }

  categories.forEach(category => {
    const groupCars = list.filter(car => (car.category || defaultCategory) === category.key);
    if (groupCars.length === 0) return;

    box.innerHTML += `<div class="car-group-title">${category.label}</div>`;
    groupCars.forEach(car => {
      box.innerHTML += buildCarCard(car);
    });
  });
}

function renderCategoryUI() {
  const grid = document.getElementById("category-grid");
  const chips = document.getElementById("filter-chips");
  const select = document.getElementById("category");

  select.innerHTML = categories
    .map(category => `<option value="${category.key}">${category.label}</option>`)
    .join("");
  select.value = defaultCategory;

  grid.innerHTML = categories.map(category => `
    <div class="category-card ${category.className}">
      <div class="d-flex justify-content-between">
        <div>
          <div class="fw-semibold">${category.label}</div>
          <div class="count" id="${category.countId}">0</div>
        </div>
        <div>
          <svg viewBox="0 0 160 80" aria-hidden="true">
            <rect x="10" y="30" width="90" height="25" rx="6" fill="rgba(255,255,255,0.55)"></rect>
            <rect x="45" y="18" width="55" height="18" rx="5" fill="rgba(255,255,255,0.55)"></rect>
            <circle cx="35" cy="58" r="10" fill="#fff"></circle>
            <circle cx="85" cy="58" r="10" fill="#fff"></circle>
            <rect x="100" y="36" width="35" height="14" rx="6" fill="rgba(255,255,255,0.55)"></rect>
          </svg>
        </div>
      </div>
      <button data-filter="${category.key}" class="filter-btn">×¡× ×Ÿ ${category.label}</button>
    </div>
  `).join("");

  chips.innerHTML = [
    '<button class="chip active" data-filter="All">×”×›×œ</button>',
    ...categories.map(category => `<button class="chip" data-filter="${category.key}">${category.label}</button>`)
  ].join("");
}

async function loadCars() {
  const errorBox = document.getElementById("add-error");
  errorBox.textContent = "";

  try {
    const res = await fetch(api + "/cars");
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
    carsCache = await res.json();
    renderCars();
  } catch (err) {
    document.getElementById("cars").innerHTML = `
      <div class="panel text-center text-danger">×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ×¨×›×‘×™×. ×‘×“×§×™ ×©×”×©×¨×ª ×¤×¢×™×œ.</div>
    `;
  }
}

async function addCar() {
  const errorBox = document.getElementById("add-error");
  errorBox.textContent = "";

  const plateInput = document.getElementById("plate");
  const modelInput = document.getElementById("model");
  const kmInput = document.getElementById("km");
  const driverInput = document.getElementById("driver");
  const statusInput = document.getElementById("status");
  const categoryInput = document.getElementById("category");

  if (!plateInput.value || !modelInput.value || !kmInput.value) {
    errorBox.textContent = "×—×•×‘×” ×œ××œ× ××¡×¤×¨ ×¨×™×©×•×™, ×“×’× ×•×§×´×.";
    return;
  }

  const kmValue = Number(kmInput.value);
  if (!Number.isFinite(kmValue)) {
    errorBox.textContent = "×§×´× ×—×™×™×‘ ×œ×”×™×•×ª ××¡×¤×¨.";
    return;
  }

  const body = {
    license_plate: plateInput.value.trim(),
    model: modelInput.value.trim(),
    km: kmValue,
    driver: driverInput.value.trim() || null,
    status: statusInput.value,
    category: categoryInput.value
  };

  try {
    const res = await fetch(api + "/cars", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || `HTTP ${res.status}`);
    }
  } catch (err) {
    errorBox.textContent = `×©×œ×™×—×” × ×›×©×œ×”: ${err.message}`;
    return;
  }

  plateInput.value = "";
  modelInput.value = "";
  kmInput.value = "";
  driverInput.value = "";
  statusInput.value = "×¤×¢×™×œ";
  categoryInput.value = defaultCategory;

  loadCars();
}

async function deleteCar(plate) {
  await fetch(api + "/cars/" + plate, { method: "DELETE" });
  loadCars();
}

function openModal(type, plate, currentValue) {
  modalState = { type, plate };
  const modal = document.getElementById("edit-modal");
  const title = document.getElementById("modal-title");
  const label = document.getElementById("modal-label");
  const input = document.getElementById("modal-input");
  const select = document.getElementById("modal-select");
  const error = document.getElementById("modal-error");

  error.textContent = "";
  input.classList.add("hidden");
  select.classList.add("hidden");

  if (type === "km") {
    title.textContent = "×¢×“×›×•×Ÿ ×§×´×";
    label.textContent = "×§×´× ×—×“×©";
    input.type = "number";
    input.min = "0";
    input.value = currentValue ?? "";
    input.classList.remove("hidden");
    input.focus();
  }

  if (type === "driver") {
    title.textContent = "×¢×“×›×•×Ÿ × ×”×’";
    label.textContent = "×©× × ×”×’";
    input.type = "text";
    input.value = currentValue ? decodeURIComponent(currentValue) : "";
    input.classList.remove("hidden");
    input.focus();
  }

  if (type === "status") {
    title.textContent = "×©×™× ×•×™ ×¡×˜×˜×•×¡";
    label.textContent = "×¡×˜×˜×•×¡";
    select.innerHTML = statusOptions.map(option => `<option value="${option}">${option}</option>`).join("");
    select.value = currentValue || statusOptions[0];
    select.classList.remove("hidden");
    select.focus();
  }

  if (type === "category") {
    title.textContent = "×©×™× ×•×™ ×§×˜×’×•×¨×™×”";
    label.textContent = "×§×˜×’×•×¨×™×”";
    select.innerHTML = categories.map(option => `<option value="${option.key}">${option.label}</option>`).join("");
    select.value = currentValue || defaultCategory;
    select.classList.remove("hidden");
    select.focus();
  }

  modal.classList.remove("hidden");
}

function closeModal() {
  document.getElementById("edit-modal").classList.add("hidden");
  document.getElementById("modal-error").textContent = "";
  modalState = { type: null, plate: null };
}

function openMaintenanceModal(plate) {
  maintenanceState = { plate, mode: "both" };
  document.getElementById("maintenance-error").textContent = "";

  const data = findCar(plate);
  const lastKm = document.getElementById("maintenance-last-km");
  const intervalKm = document.getElementById("maintenance-interval-km");
  const lastDate = document.getElementById("maintenance-last-date");
  const intervalDays = document.getElementById("maintenance-interval-days");

  lastKm.value = data?.maintenance_last_km ?? "";
  intervalKm.value = data?.maintenance_interval_km ?? "";
  lastDate.value = data?.maintenance_last_date ?? "";
  intervalDays.value = data?.maintenance_interval_days ?? "";

  const hasKm = !!(data?.maintenance_last_km || data?.maintenance_interval_km);
  const hasTime = !!(data?.maintenance_last_date || data?.maintenance_interval_days);
  if (hasKm && !hasTime) {
    setMaintenanceMode("km");
  } else if (!hasKm && hasTime) {
    setMaintenanceMode("time");
  } else {
    setMaintenanceMode("both");
  }

  document.getElementById("maintenance-modal").classList.remove("hidden");
}

function closeMaintenanceModal() {
  document.getElementById("maintenance-modal").classList.add("hidden");
  document.getElementById("maintenance-error").textContent = "";
  maintenanceState = { plate: null, mode: "both" };
}

function setMaintenanceMode(mode) {
  maintenanceState.mode = mode;
  document.querySelectorAll("[data-maintenance-mode]").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.maintenanceMode === mode);
  });
  document.getElementById("maintenance-km-fields").classList.toggle("hidden", mode === "time");
  document.getElementById("maintenance-time-fields").classList.toggle("hidden", mode === "km");
}

async function submitMaintenance() {
  const error = document.getElementById("maintenance-error");
  error.textContent = "";

  const lastKm = document.getElementById("maintenance-last-km").value;
  const intervalKm = document.getElementById("maintenance-interval-km").value;
  const lastDate = document.getElementById("maintenance-last-date").value;
  const intervalDays = document.getElementById("maintenance-interval-days").value;

  const payload = {
    lastKm: lastKm ? Number(lastKm) : null,
    intervalKm: intervalKm ? Number(intervalKm) : null,
    lastDate: lastDate || null,
    intervalDays: intervalDays ? Number(intervalDays) : null
  };

  if (maintenanceState.mode === "km" && (!payload.lastKm || !payload.intervalKm)) {
    error.textContent = "×™×© ×œ×”×–×™×Ÿ ×§×´× ××—×¨×•×Ÿ ×•××¨×•×•×— ×˜×™×¤×•×œ ×‘×§×´×.";
    return;
  }

  if (maintenanceState.mode === "time" && (!payload.lastDate || !payload.intervalDays)) {
    error.textContent = "×™×© ×œ×”×–×™×Ÿ ×ª××¨×™×š ××—×¨×•×Ÿ ×•××¨×•×•×— ×™××™×.";
    return;
  }

  try {
    const res = await fetch(`${api}/cars/${maintenanceState.plate}/maintenance`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        maintenance_last_km: payload.lastKm,
        maintenance_interval_km: payload.intervalKm,
        maintenance_last_date: payload.lastDate,
        maintenance_interval_days: payload.intervalDays
      })
    });
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}`);
    }
  } catch (err) {
    error.textContent = "×©××™×¨×ª ×˜×™×¤×•×œ × ×›×©×œ×”. × ×¡×™ ×©×•×‘.";
    return;
  }

  closeMaintenanceModal();
  loadCars();
}

async function submitModal() {
  const error = document.getElementById("modal-error");
  error.textContent = "";

  const input = document.getElementById("modal-input");
  const select = document.getElementById("modal-select");
  const { type, plate } = modalState;

  try {
    if (type === "km") {
      const kmValue = Number(input.value);
      if (!Number.isFinite(kmValue)) {
        error.textContent = "×§×´× ×—×™×™×‘ ×œ×”×™×•×ª ××¡×¤×¨.";
        return;
      }
      const res = await fetch(`${api}/cars/${plate}?km=${kmValue}`, { method: "PUT" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
    }

    if (type === "driver") {
      const newDriver = input.value.trim();
      const res = await fetch(`${api}/cars/${plate}/driver?driver=${encodeURIComponent(newDriver)}`, { method: "PUT" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
    }

    if (type === "status") {
      const newStatus = select.value;
      const res = await fetch(`${api}/cars/${plate}/status?status=${encodeURIComponent(newStatus)}`, { method: "PUT" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
    }

    if (type === "category") {
      const res = await fetch(`${api}/cars/${plate}/category?category=${encodeURIComponent(select.value)}`, { method: "PUT" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
    }
  } catch (err) {
    error.textContent = "×©××™×¨×” × ×›×©×œ×”. × ×¡×™ ×©×•×‘.";
    return;
  }

  closeModal();
  loadCars();
}

function setFilter(filter) {
  activeFilter = filter;
  document.querySelectorAll(".chip").forEach(chip => {
    chip.classList.toggle("active", chip.dataset.filter === filter);
  });
  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.filter === filter);
  });
  renderCars();
}

window.onload = () => {
  renderCategoryUI();
  document.getElementById("add-btn").addEventListener("click", addCar);
  document.getElementById("search").addEventListener("input", renderCars);
  document.querySelectorAll(".chip").forEach(chip => {
    chip.addEventListener("click", () => setFilter(chip.dataset.filter));
  });
  document.querySelectorAll(".filter-btn").forEach(btn => {
    btn.addEventListener("click", () => setFilter(btn.dataset.filter));
  });
  document.querySelectorAll("[data-maintenance-mode]").forEach(btn => {
    btn.addEventListener("click", () => setMaintenanceMode(btn.dataset.maintenanceMode));
  });
  loadCars();
};
</script>

</body>
</html>
